<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Octopus Easy Mode</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .table td i {
            margin-top: 1rem;
        }
        .table tbody tr {
            border-top: 2rem solid transparent;
        }
        .table tbody tr:first-child {
            border-top: none;
        }
        .table {
            border-collapse: separate;
            border-spacing: 0.5rem;
            table-layout: fixed;
        }
        .table th {
            width: 150px;
        }
        .table td {
            width: auto;
        }
        .platform-cell {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 1.5rem 1rem;
            border-radius: 0.5rem;
        }
        .platform-cell:hover {
            background-color: #f8f9fa;
        }
        .platform-cell.selected {
            background-color: #0d6efd;
            color: white;
        }
        .platform-cell.selected i {
            color: white;
        }
        .platform-cell.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        .disabled-message {
            color: #dc3545;
            font-size: 0.875rem;
            font-style: italic;
            margin-top: 0.25rem;
        }
        .copy-btn {
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script type="module">
        import { h, render } from 'https://esm.sh/preact';
        import { useState, useEffect } from 'https://esm.sh/preact/hooks';
        import htm from 'https://esm.sh/htm';
        const html = htm.bind(h);

        function App() {
            // Load initial state from localStorage or use defaults
            const loadFromStorage = (key, defaultValue) => {
                try {
                    const saved = localStorage.getItem(key);
                    return saved !== null ? JSON.parse(saved) : defaultValue;
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                    return defaultValue;
                }
            };

            const [selectedPlatform, setSelectedPlatform] = useState(() => loadFromStorage('selectedPlatform', 'kubernetes'));
            const [selectedTenant, setSelectedTenant] = useState(() => loadFromStorage('selectedTenant', null));
            const [selectedRunbooks, setSelectedRunbooks] = useState(() => loadFromStorage('selectedRunbooks', []));
            const [selectedChannels, setSelectedChannels] = useState(() => loadFromStorage('selectedChannels', []));
            const [promptText, setPromptText] = useState('');
            const [copyButtonText, setCopyButtonText] = useState('Copy to clipboard');

            const platforms = [
                { id: 'kubernetes', name: 'Kubernetes', icon: 'fas fa-dharmachakra', prompt: 'Create a Kubernetes project called "My K8s WebApp", and then:\n* Configure the Kubernetes steps to use client side apply (client side apply is required by the Mock K8s target).\n* Disable verification checks in the Kubernetes steps (verification checks are not supported by the Mock K8s target).\n* Create a token account called "Mock Token".\n* Create a feed called "Docker Hub" pointing to "https://index.docker.io" using anonymous authentication.\n* Add a target called "Mock K8s", with the tag "Kubernetes", using the token account, pointing to "https://mockk8sserver.orangegrass-c0938ea8.westus2.azurecontainerapps.io", using the health check image "octopusdeploy/worker-tools:6.5.0-ubuntu.22.04" from the "Docker Hub" feed, using the worker pool "Hosted Ubuntu".' },
                { id: 'argocd', name: 'Argo CD', icon: 'fas fa-circle-nodes', prompt: 'Create an Argo CD project called "My Argo CD WebApp"' },
                { id: 'azurewebapp', name: 'Azure Web App', icon: 'fab fa-microsoft', prompt: 'Create an Azure Web App project called "My Azure WebApp"' },
                { id: 'azurefunctions', name: 'Azure Functions', icon: 'fas fa-bolt', prompt: 'Create an Azure Functions project called "My Azure Function App"' },
                { id: 'awslambda', name: 'AWS Lambda', icon: 'fab fa-aws', prompt: 'Create an AWS Lambda project called "My AWS Lambda App"' },
                { id: 'scriptstep', name: 'Script Step', icon: 'fas fa-terminal', prompt: 'Create a script project called "My Script App"' }
            ];

            const tenants = [
                { id: 'regional', name: 'Regional', icon: 'fas fa-globe', instruction: '* Add 5 tenants based on geographical regions, link the tenants to the project, and require tenants to deploy the project. Configure all targets, accounts, and certificates to support tenanted and untenanted deployments. Link the tenants to all targets, accounts, and certificates.' },
                { id: 'physical', name: 'Physical', icon: 'fas fa-building', instruction: '* Add 5 tenants based on random brick and mortar store names, link the tenants to the project, and require tenants to deploy the project. Configure all targets, accounts, and certificates to support tenanted and untenanted deployments. Link the tenants to all targets, accounts, and certificates.' },
                { id: 'businessunit', name: 'Business Unit', icon: 'fas fa-sitemap', instruction: '* Add 5 tenants based on random business unit names, link the tenants to the project, and require tenants to deploy the project. Configure all targets, accounts, and certificates to support tenanted and untenanted deployments. Link the tenants to all targets, accounts, and certificates.' },
                { id: 'company', name: 'Company', icon: 'fas fa-briefcase', instruction: '* Add 5 tenants based on fictional company names, link the tenants to the project, and require tenants to deploy the project. Configure all targets, accounts, and certificates to support tenanted and untenanted deployments. Link the tenants to all targets, accounts, and certificates.' }
            ];

            const runbooks = [
                { id: 'database', name: 'Database', icon: 'fas fa-database', instruction: '* Add a runbook to simulate a database backup.' },
                { id: 'service', name: 'Service', icon: 'fas fa-cogs', instruction: '* Add a runbook to simulate the restart of the service.' },
                { id: 'logs', name: 'Logs', icon: 'fas fa-file-alt', instruction: '* Add a runbook to simulate the retrieval of logs.' }
            ];


            const channels = [
                { id: 'hotfix', name: 'Hot Fix', icon: 'fas fa-fire-extinguisher', instruction: '* Create a Hot Fix channel.' },
                { id: 'featurebranch', name: 'Feature Branch', icon: 'fas fa-code-branch', instruction: '* Create a Feature Branch channel.' }
            ];

            // Save to localStorage whenever selections change
            useEffect(() => {
                localStorage.setItem('selectedPlatform', JSON.stringify(selectedPlatform));
            }, [selectedPlatform]);

            useEffect(() => {
                localStorage.setItem('selectedTenant', JSON.stringify(selectedTenant));
            }, [selectedTenant]);

            useEffect(() => {
                localStorage.setItem('selectedRunbooks', JSON.stringify(selectedRunbooks));
            }, [selectedRunbooks]);

            useEffect(() => {
                localStorage.setItem('selectedChannels', JSON.stringify(selectedChannels));
            }, [selectedChannels]);

            // Generate prompt on initial load and when selections change
            useEffect(() => {
                const prompt = generatePrompt(selectedPlatform, selectedTenant, selectedRunbooks, selectedChannels);
                setPromptText(prompt);
            }, [selectedPlatform, selectedTenant, selectedRunbooks, selectedChannels]);

            // Check if runbooks and channels should be disabled
            const isRunbooksChannelsDisabled = selectedPlatform === 'kubernetes' && selectedTenant !== null;

            // Clear runbooks and channels when they become disabled
            useEffect(() => {
                if (isRunbooksChannelsDisabled) {
                    if (selectedRunbooks.length > 0) {
                        setSelectedRunbooks([]);
                    }
                    if (selectedChannels.length > 0) {
                        setSelectedChannels([]);
                    }
                }
            }, [isRunbooksChannelsDisabled]);

            const generatePrompt = (platformId, tenantId, runbookIds, channelIds) => {
                const platform = platforms.find(p => p.id === platformId);
                if (!platform) return '';

                let prompt = platform.prompt;
                const additionalInstructions = [];

                if (tenantId) {
                    const tenant = tenants.find(t => t.id === tenantId);
                    if (tenant && tenant.instruction) {
                        additionalInstructions.push(tenant.instruction);
                    }
                }

                if (runbookIds && runbookIds.length > 0) {
                    runbookIds.forEach(runbookId => {
                        const runbook = runbooks.find(r => r.id === runbookId);
                        if (runbook && runbook.instruction) {
                            additionalInstructions.push(runbook.instruction);
                        }
                    });
                }


                if (channelIds && channelIds.length > 0) {
                    channelIds.forEach(channelId => {
                        const channel = channels.find(c => c.id === channelId);
                        if (channel && channel.instruction) {
                            additionalInstructions.push(channel.instruction);
                        }
                    });
                }

                if (additionalInstructions.length > 0) {
                    if (prompt.indexOf(', and then:') === -1) {
                        prompt += ', and then:\n'
                    } else {
                        prompt += '\n';
                    }
                    prompt += additionalInstructions.join('\n');
                }

                return prompt;
            };

            const handlePlatformClick = (platformId) => {
                if (selectedPlatform === platformId) return;
                setSelectedPlatform(platformId);
            };

            const handleTenantClick = (tenantId) => {
                const newTenantId = selectedTenant === tenantId ? null : tenantId;
                setSelectedTenant(newTenantId);
            };

            const handleRunbookClick = (runbookId) => {
                if (isRunbooksChannelsDisabled) return;
                const newRunbooks = selectedRunbooks.includes(runbookId)
                    ? selectedRunbooks.filter(id => id !== runbookId)
                    : [...selectedRunbooks, runbookId];
                setSelectedRunbooks(newRunbooks);
            };


            const handleChannelClick = (channelId) => {
                if (isRunbooksChannelsDisabled) return;
                const newChannels = selectedChannels.includes(channelId)
                    ? selectedChannels.filter(id => id !== channelId)
                    : [...selectedChannels, channelId];
                setSelectedChannels(newChannels);
            };

            const handleCopyToClipboard = () => {
                navigator.clipboard.writeText(promptText).then(() => {
                    setCopyButtonText('Copied');
                    setTimeout(() => {
                        setCopyButtonText('Copy to clipboard');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            };

            return html`
                <div class="container mt-5">
                    <h1 class="mb-4">Octopus Easy Mode</h1>
                    <table class="table">
                        <tbody>
                            <tr>
                                <th scope="row">Platform</th>
                                ${platforms.map(platform => html`
                                    <td
                                        class="text-center platform-cell ${selectedPlatform === platform.id ? 'selected' : ''}"
                                        onClick=${() => handlePlatformClick(platform.id)}
                                    >
                                        ${platform.name}<br/>
                                        <i class="${platform.icon} fa-2x"></i>
                                    </td>
                                `)}
                            </tr>
                            <tr>
                                <th scope="row">Tenants</th>
                                ${tenants.map(tenant => html`
                                    <td
                                        class="text-center platform-cell ${selectedTenant === tenant.id ? 'selected' : ''}"
                                        onClick=${() => handleTenantClick(tenant.id)}
                                    >
                                        ${tenant.name}<br/>
                                        <i class="${tenant.icon} fa-2x"></i>
                                    </td>
                                `)}
                            </tr>
                            <tr>
                                <th scope="row">
                                    Runbooks
                                    ${isRunbooksChannelsDisabled && html`<div class="disabled-message">Prompt complexity limit reached</div>`}
                                </th>
                                ${runbooks.map(runbook => html`
                                    <td
                                        class="text-center platform-cell ${selectedRunbooks.includes(runbook.id) ? 'selected' : ''} ${isRunbooksChannelsDisabled ? 'disabled' : ''}"
                                        onClick=${() => handleRunbookClick(runbook.id)}
                                    >
                                        ${runbook.name}<br/>
                                        <i class="${runbook.icon} fa-2x"></i>
                                    </td>
                                `)}
                            </tr>
                            <tr>
                                <th scope="row">
                                    Channels
                                    ${isRunbooksChannelsDisabled && html`<div class="disabled-message">Prompt complexity limit reached</div>`}
                                </th>
                                ${channels.map(channel => html`
                                    <td
                                        class="text-center platform-cell ${selectedChannels.includes(channel.id) ? 'selected' : ''} ${isRunbooksChannelsDisabled ? 'disabled' : ''}"
                                        onClick=${() => handleChannelClick(channel.id)}
                                    >
                                        ${channel.name}<br/>
                                        <i class="${channel.icon} fa-2x"></i>
                                    </td>
                                `)}
                            </tr>
                        </tbody>

                    </table>

                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="mb-0">Prompt</h3>
                            <button class="btn btn-primary copy-btn" onClick=${handleCopyToClipboard}>
                                <i class="fas fa-copy me-2"></i>${copyButtonText}
                            </button>
                        </div>
                        <textarea
                            class="form-control"
                            rows="10"
                            placeholder="Enter your prompt here..."
                            value=${promptText}
                            onInput=${(e) => setPromptText(e.target.value)}
                        ></textarea>
                    </div>
                </div>
            `;
        }

        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>

